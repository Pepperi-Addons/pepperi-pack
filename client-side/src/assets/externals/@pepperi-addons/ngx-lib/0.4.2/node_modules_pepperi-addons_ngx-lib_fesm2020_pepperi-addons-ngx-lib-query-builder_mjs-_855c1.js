(self.webpackChunkblock=self.webpackChunkblock||[]).push([["node_modules_pepperi-addons_ngx-lib_fesm2020_pepperi-addons-ngx-lib-query-builder_mjs-_855c1"],{16130:(xe,b,c)=>{c.r(b),c.d(b,{PepQueryBuilderComponent:()=>De,PepQueryBuilderModule:()=>Ee,PepQueryBuilderService:()=>x});var t=c(60562),f=c(62923),d=c(51959),Q=c(21756),a=c(20349),T=c(73365),g=c(21165),P=c(32271),w=c(47593),y=c(85137),F=c(21569);const M=["sectionContainer"];function V(n,o){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-button",8),t.\u0275\u0275listener("buttonClick",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(i.onAddRuleSetClicked())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext();t.\u0275\u0275advance(1),t.\u0275\u0275property("disabled",!e.hasFields)("visible",!0)}}function L(n,o){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"pep-button",9),t.\u0275\u0275listener("buttonClick",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(i.onDeleteSectionClicked())}),t.\u0275\u0275elementEnd()}2&n&&t.\u0275\u0275property("disabled",!1)("visible",!0)}function q(n,o){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-text-filter",7),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("variableField",null==e.variableFields?null:e.variableFields.text)("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("renderTitle",!1)}}function N(n,o){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-boolean-filter",8),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("variableField",null==e.variableFields?null:e.variableFields.boolean)("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("options",e.typeConvertorService.booleans)("renderTitle",!1)}}function R(n,o){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-date-filter",9),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("showAdditionalOperators",!0)("variableField",null==e.variableFields?null:e.variableFields.date)("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("renderTitle",!1)}}function A(n,o){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-multi-select-filter",7),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("variableField",null==e.variableFields?null:e.variableFields["multi-select"])("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("renderTitle",!1)}}function k(n,o){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-number-filter",7),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("variableField",null==e.variableFields?null:e.variableFields.number)("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("renderTitle",!1)}}function U(n,o){if(1&n&&(t.\u0275\u0275elementContainerStart(0)(1,5),t.\u0275\u0275template(2,q,2,8,"ng-container",6),t.\u0275\u0275template(3,N,2,9,"ng-container",6),t.\u0275\u0275template(4,R,2,9,"ng-container",6),t.\u0275\u0275template(5,A,2,8,"ng-container",6),t.\u0275\u0275template(6,k,2,8,"ng-container",6),t.\u0275\u0275elementContainerEnd()()),2&n){const e=t.\u0275\u0275nextContext();t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitch",e._selectedField.componentType),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","text"),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","boolean"),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","date"),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","multi-select"),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","number")}}const W=["rootContainer"];let C=(()=>{class n{constructor(){this._operators=[],this._booleans=[],this.initOperators(),this.initBooleans()}get operators(){return this._operators}get booleans(){return this._booleans}initOperators(){this._operators.push({key:"AND",value:"And"}),this._operators.push({key:"OR",value:"Or"})}initBooleans(){this._booleans.push({key:"True",value:"True"}),this._booleans.push({key:"False",value:"False"})}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=t.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n})(),O=(()=>{class n{constructor(e){this._typeConvertorService=e,this.hasFields=!0,this.createSection=new t.EventEmitter,this.createItem=new t.EventEmitter,this.remove=new t.EventEmitter,this.operatorChange=new t.EventEmitter}ngOnInit(){this.initOperators()}get f(){return this.form.controls}initOperators(){this.toggleButtons=this._typeConvertorService.operators.map(e=>({key:e.key,value:e.value,callback:r=>this.onOperatorChanged(r)}))}onOperatorChanged(e){e?.source?.key&&(this.f.operator.setValue(e.source.key),this.operatorChange.emit())}onAddRuleClicked(){this.createItem.emit()}onAddRuleSetClicked(){this.createSection.emit()}onDeleteSectionClicked(){this.remove.emit()}}return n.\u0275fac=function(e){return new(e||n)(t.\u0275\u0275directiveInject(C))},n.\u0275cmp=t.\u0275\u0275defineComponent({type:n,selectors:[["pep-query-builder-section"]],viewQuery:function(e,r){if(1&e&&t.\u0275\u0275viewQuery(M,7,t.ViewContainerRef),2&e){let i;t.\u0275\u0275queryRefresh(i=t.\u0275\u0275loadQuery())&&(r.sectionContainer=i.first)}},inputs:{form:"form",depth:"depth",hasFields:"hasFields"},outputs:{createSection:"createSection",createItem:"createItem",remove:"remove",operatorChange:"operatorChange"},decls:10,vars:8,consts:[["fxLayout","row","fxLayoutGap",".5rem"],["fxLayout","column","fxLayoutGap",".5rem",1,"query-section-container"],["fxLayout","row","fxLayoutAlign","space-between"],["styleType","weak","sizeType","sm",3,"buttons","selectedButtonKey","viewType","buttonsDisabled"],["value","Add Filter","styleType","weak","styleStateType","system","sizeType","sm","classNames","","iconName","number_plus","iconPosition","end",3,"disabled","visible","buttonClick"],[4,"ngIf"],["sectionContainer",""],["styleType","weak","styleStateType","system","sizeType","md","classNames","","iconName","system_bin","iconPosition","end",3,"disabled","visible","buttonClick",4,"ngIf"],["value","Add Filter Group","styleType","weak","styleStateType","system","sizeType","sm","classNames","","iconName","number_plus","iconPosition","end",3,"disabled","visible","buttonClick"],["styleType","weak","styleStateType","system","sizeType","md","classNames","","iconName","system_bin","iconPosition","end",3,"disabled","visible","buttonClick"]],template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"div",0)(1,"div",1)(2,"div",2),t.\u0275\u0275element(3,"pep-group-buttons",3),t.\u0275\u0275elementStart(4,"div",0)(5,"pep-button",4),t.\u0275\u0275listener("buttonClick",function(){return r.onAddRuleClicked()}),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(6,V,2,2,"ng-container",5),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainer(7,null,6),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(9,L,1,2,"pep-button",7),t.\u0275\u0275elementEnd()),2&e&&(t.\u0275\u0275advance(3),t.\u0275\u0275property("buttons",r.toggleButtons)("selectedButtonKey",(null==r.f.operator?null:r.f.operator.value)||"")("viewType","toggle")("buttonsDisabled",!r.hasFields),t.\u0275\u0275advance(2),t.\u0275\u0275property("disabled",!r.hasFields)("visible",!0),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",r.depth.current<r.depth.max-1),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngIf",r.depth.current>0))},dependencies:[f.NgIf,y.DefaultLayoutDirective,y.DefaultLayoutGapDirective,y.DefaultLayoutAlignDirective,g.PepButtonComponent,P.PepGroupButtonsComponent],styles:[".query-section-container[_ngcontent-%COMP%]{border-radius:var(--pep-border-radius-md, .25rem);padding:.5rem;width:100%}",".query-section-container[_ngcontent-%COMP%]{box-shadow:var(--pep-shadow-sm-offset, 0 .25rem .5rem 0) hsla(var(--pep-color-system-primary-h, 0),var(--pep-color-system-primary-s, 0%),var(--pep-color-system-primary-l, 10%),.08);border:1px solid hsla(var(--pep-color-system-primary-h, 0),var(--pep-color-system-primary-s, 0%),var(--pep-color-system-primary-l, 10%),.24)}"]}),n})(),j=(()=>{class n{constructor(e,r){this._fb=e,this.typeConvertorService=r,this._fields=[],this._options=[],this._selectedField=null,this.variableFields={},this.filterChange=new t.EventEmitter,this.remove=new t.EventEmitter,this.setupForm()}set fields(e){e?.length>0&&(this._fields=e,this._options=e.map(r=>({key:r.smart.id,value:r.smart.name})))}set selected(e){e&&(this._selectedField=e.smart,this.queryForm.fieldType.setValue(e.query.fieldType))}set filter(e){e&&(this._filter=e)}set parentForm(e){e&&(this._parentForm=e,this.addToParentForm())}ngOnInit(){}get f(){return this.form.controls}get queryForm(){return this.f.query.controls}setupForm(){this.form=this._fb.group({smart:this._fb.group({fieldId:this._fb.control(null),fieldType:this._fb.control(null),operator:this._fb.control(null),operatorUnit:this._fb.control(null),values:this._fb.group({first:this._fb.control(null),second:this._fb.control(null)})}),query:this._fb.group({fieldType:this._fb.control(null)})})}addToParentForm(){this._parentForm.setControl(this.formKey,this.form)}onFieldChanged(e){const r=this._fields.find(i=>i.smart.id===e);this.setupForm(),this.queryForm.fieldType.setValue(r.query.fieldType),this.addToParentForm(),this._selectedField=null,setTimeout(()=>{this._selectedField=r?r.smart:null},0),this._filter=null}onFilterChanged(){this.form.valid&&this.filterChange.emit()}onDeleteItemClicked(){this.remove.emit()}}return n.\u0275fac=function(e){return new(e||n)(t.\u0275\u0275directiveInject(d.FormBuilder),t.\u0275\u0275directiveInject(C))},n.\u0275cmp=t.\u0275\u0275defineComponent({type:n,selectors:[["pep-query-builder-item"]],inputs:{formKey:"formKey",fields:"fields",selected:"selected",filter:"filter",parentForm:"parentForm",variableFields:"variableFields"},outputs:{filterChange:"filterChange",remove:"remove"},decls:5,vars:6,consts:[["fxLayout","column","fxLayoutGap",".5rem"],["fxLayout","row","fxLayoutGap",".5rem"],["fxFlex","25%","xAlignment","left",3,"value","options","renderTitle","valueChange"],[4,"ngIf"],["styleType","weak","styleStateType","system","sizeType","md","classNames","","iconName","system_bin","iconPosition","end",3,"disabled","visible","buttonClick"],[3,"ngSwitch"],[4,"ngSwitchCase"],["fxFlex","auto",3,"showActionButtons","variableField","field","filter","parentForm","emitOnChange","inline","renderTitle","filterChange"],["fxFlex","auto",3,"showActionButtons","variableField","field","filter","parentForm","emitOnChange","inline","options","renderTitle","filterChange"],["fxFlex","auto",3,"showActionButtons","showAdditionalOperators","variableField","field","filter","parentForm","emitOnChange","inline","renderTitle","filterChange"]],template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"div",0)(1,"div",1)(2,"pep-select",2),t.\u0275\u0275listener("valueChange",function(l){return r.onFieldChanged(l)}),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(3,U,7,6,"ng-container",3),t.\u0275\u0275elementStart(4,"pep-button",4),t.\u0275\u0275listener("buttonClick",function(){return r.onDeleteItemClicked()}),t.\u0275\u0275elementEnd()()()),2&e&&(t.\u0275\u0275advance(2),t.\u0275\u0275property("value",null==r._selectedField?null:r._selectedField.id)("options",r._options)("renderTitle",!1),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",null==r._selectedField?null:r._selectedField.componentType),t.\u0275\u0275advance(1),t.\u0275\u0275property("disabled",!1)("visible",!0))},dependencies:[f.NgIf,f.NgSwitch,f.NgSwitchCase,y.DefaultLayoutDirective,y.DefaultLayoutGapDirective,y.DefaultFlexDirective,T.PepSelectComponent,g.PepButtonComponent,a.PepTextFilterComponent,a.PepBooleanFilterComponent,a.PepDateFilterComponent,a.PepMultiSelectFilterComponent,a.PepNumberFilterComponent],styles:[".pep-field-no-spacing{min-height:0!important;margin-bottom:0!important}"]}),n})();class I{constructor(){this.loadTypes()}loadTypes(){this.map=new Map,this.map.set("Bool","boolean"),this.map.set("JsonBool","boolean"),this.map.set("Integer","int"),this.map.set("Double","real"),this.map.set("String","text"),this.map.set("Guid","text"),this.map.set("Date","date"),this.map.set("DateTime","date-time"),this.map.set("MultipleStringValues","multi-select")}getSmartFilterType(o){return this.map.get(o)||null}}var h=(()=>{return(n=h||(h={})).And="AND",n.Or="OR",h;var n})();const S=[{legacy:"IsEqual",valueType:"Static",smartFilter:a.PepSmartFilterOperators.Equals,type:["boolean","int","text","real"]},{legacy:"IsEqual",valueType:"Dynamic",smartFilter:a.PepSmartFilterVariableOperators.EqualsToVariable,type:["boolean","int","text","multi-select"]},{legacy:"IsNotEqual",valueType:"Static",smartFilter:a.PepSmartFilterOperators.NotEqual,type:null},{legacy:"IsNotEqual",valueType:"Dynamic",smartFilter:a.PepSmartFilterVariableOperators.NotEqualsToVariable,type:["boolean","multi-select"]},{legacy:"<",valueType:"Static",smartFilter:a.PepSmartFilterOperators.LessThan,type:null},{legacy:"<",valueType:"Dynamic",smartFilter:a.PepSmartFilterVariableOperators.LessThanVariable,type:null},{legacy:">",valueType:"Static",smartFilter:a.PepSmartFilterOperators.GreaterThan,type:null},{legacy:">",valueType:"Dynamic",smartFilter:a.PepSmartFilterVariableOperators.GreaterThanVariable,type:null},{legacy:"Between",valueType:"Static",smartFilter:a.PepSmartFilterOperators.NumberRange,type:["int"]},{legacy:"Contains",valueType:"Static",smartFilter:a.PepSmartFilterOperators.Contains,type:null},{legacy:"StartWith",valueType:"Static",smartFilter:a.PepSmartFilterOperators.BeginsWith,type:null},{legacy:"EndWith",valueType:"Static",smartFilter:a.PepSmartFilterOperators.EndsWith,type:null},{legacy:"InTheLast",valueType:"Static",smartFilter:a.PepSmartFilterOperators.InTheLast,type:null},{legacy:"InTheLastCalendar",valueType:"Static",smartFilter:a.PepSmartFilterAdditionalOperators.InTheLastCalendar,type:null},{legacy:"NotInTheLast",valueType:"Static",smartFilter:a.PepSmartFilterOperators.NotInTheLast,type:null},{legacy:"NotInTheLastCalendar",valueType:"Static",smartFilter:a.PepSmartFilterAdditionalOperators.NotInTheLastCalendar,type:null},{legacy:"Today",valueType:"Static",smartFilter:a.PepSmartFilterOperators.Today,type:null},{legacy:"ThisWeek",valueType:"Static",smartFilter:a.PepSmartFilterOperators.ThisWeek,type:null},{legacy:"ThisMonth",valueType:"Static",smartFilter:a.PepSmartFilterOperators.ThisMonth,type:null},{legacy:"Between",valueType:"Static",smartFilter:a.PepSmartFilterOperators.DateRange,type:["date-time"]},{legacy:"Between",valueType:"Dynamic",smartFilter:a.PepSmartFilterVariableOperators.DateRangeVariable,type:["date-time"]},{legacy:"DueIn",valueType:"Static",smartFilter:a.PepSmartFilterOperators.DueIn,type:null},{legacy:"NotDueIn",valueType:"Static",smartFilter:a.PepSmartFilterOperators.NotDueIn,type:null},{legacy:"On",valueType:"Static",smartFilter:a.PepSmartFilterOperators.On,type:null},{legacy:"IsEmpty",valueType:"Static",smartFilter:a.PepSmartFilterOperators.IsEmpty,type:null},{legacy:"IsNotEmpty",valueType:"Static",smartFilter:a.PepSmartFilterOperators.IsNotEmpty,type:null},{legacy:"IsEqual",valueType:"Static",smartFilter:a.PepSmartFilterOperators.In,type:["multi-select"]}];function ge(n,o){const e=S.find(r=>r.smartFilter===n&&(null===r.type||r.type.includes(o)));return e?e.legacy:null}function Fe(n,o){const e=S.find(r=>r.smartFilter===n&&(null===r.type||r.type.includes(o)));return e?e.valueType:"Static"}const D=[{legacy:"Days",smartFilter:a.PepSmartFilterOperatorUnits.Days},{legacy:"Weeks",smartFilter:a.PepSmartFilterOperatorUnits.Weeks},{legacy:"Months",smartFilter:a.PepSmartFilterOperatorUnits.Months},{legacy:"Years",smartFilter:a.PepSmartFilterOperatorUnits.Years}];let E=(()=>{class n{constructor(){}generateQuery(e){return this.initParams(),this.sectionWalk(e)}initParams(){this._complexIdCounter=1,this._expressionIdCounter=1}sectionWalk(e){let r=null;return Object.keys(e).forEach(i=>{if(i.includes("item"))r=this.addToSection(r,{ExpressionId:(this._expressionIdCounter++).toString(),ApiName:e[i].smart.fieldId,FieldType:e[i].query.fieldType,Operation:ge(e[i].smart.operator,e[i].smart.fieldType),ValueType:Fe(e[i].smart.operator,e[i].smart.fieldType),Values:this.getItemValues(e[i].smart)},e.operator);else if(i.includes("section")){const l=this.sectionWalk(e[i]);l&&(r=this.addToSection(r,l,e.operator))}}),r}addToSection(e,r,i){return e?this.createSection(e,r,i):r}createSection(e,r,i){return{ComplexId:(this._complexIdCounter++).toString(),LeftNode:e,RightNode:r,Operation:i}}getItemValues(e){let r=[];return e?.values?.first&&(e.operator===a.PepSmartFilterOperators.In?r=e.values.first:e.operator===a.PepSmartFilterOperators.InTheLast||e.operator===a.PepSmartFilterAdditionalOperators.InTheLastCalendar||e.operator===a.PepSmartFilterOperators.NotInTheLast||e.operator===a.PepSmartFilterAdditionalOperators.NotInTheLastCalendar||e.operator===a.PepSmartFilterOperators.DueIn||e.operator===a.PepSmartFilterOperators.NotDueIn?(r.push(e.values.first),e.operatorUnit&&r.push(function Oe(n){const o=D.find(e=>e.smartFilter===n);return o?o.legacy:null}(e.operatorUnit))):(r.push(e.values.first),e.values.second&&r.push(e.values.second))),r}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=t.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n})(),x=(()=>{class n{constructor(){}getFilter(e,r){const i=function ve(n,o,e){const r=S.find(i=>i.legacy===n&&i.valueType===e&&(null===i.type||i.type.includes(o)));return r?r.smartFilter:null}(e.Operation,r.type,e.ValueType||"Static");if(i){const l=this.getFilterValues(e,i,r);return(0,a.createSmartFilter)(e.ApiName,i,l.first,l.second,l.operationUnit)}return null}convertToSmartFilterFields(e){if(e?.length>0){const r=new I;return e.map(i=>({smart:(0,a.createSmartFilterField)({id:i.FieldID,name:i.Title,options:i.OptionalValues?.map(l=>({key:l.Key,value:l.Value}))},r.getSmartFilterType(i.FieldType)),query:{fieldType:i.FieldType}}))}return[]}getFilterValues(e,r,i){const l={first:null,second:null,operationUnit:null};return r===a.PepSmartFilterOperators.In?l.first=e?.Values?.length>0?e.Values.filter(p=>i.options.find(s=>s.key===p)):null:r===a.PepSmartFilterOperators.InTheLast||r===a.PepSmartFilterAdditionalOperators.InTheLastCalendar||r===a.PepSmartFilterOperators.NotInTheLast||r===a.PepSmartFilterAdditionalOperators.NotInTheLastCalendar||r===a.PepSmartFilterOperators.DueIn||r===a.PepSmartFilterOperators.NotDueIn?(l.first=e?.Values?.length>0?e.Values[0]:null,2===e?.Values?.length&&(l.operationUnit=function Pe(n){const o=D.find(e=>e.legacy===n);return o?o.smartFilter:null}(e.Values[1]))):(l.first=e?.Values?.length>0?e.Values[0]:null,l.second=2===e?.Values?.length?e.Values[1]:null),l}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=t.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac,providedIn:"root"}),n})(),B=(()=>{class n{constructor(e,r,i){this._resolver=e,this._outputQueryService=r,this._queryBuilderService=i,this._outputQuery$=new w.BehaviorSubject(null),this._variableFields={},this._maxStructureDepth=3,this._cmpRefMap=new Map,this.outputQuery$=this._outputQuery$.asObservable()}set maxDepth(e){this._maxStructureDepth=e}get maxDepth(){return this._maxStructureDepth}set fields(e){this._smartFilterFields=this._queryBuilderService.convertToSmartFilterFields(e)}get hasFields(){return this._smartFilterFields?.length>0}set variableFields(e){if(e?.length){const r=new I;e.forEach(i=>{const l=this.convertSmartFilterComponentType(r.getSmartFilterType(i.FieldType));this.hasProperty(this._variableFields,l)?this._variableFields[l].push(i.FieldID):this._variableFields[l]=[i.FieldID]})}}set form(e){this._form=e}get form(){return this._form}buildQueryStructure(e,r){this._cmpRefMap.forEach((i,l)=>{i.instance.parentForm&&i.instance.parentForm.removeControl(l),i.destroy(),this._cmpRefMap.delete(l)}),r.clear(),this.hasProperty(e,"ComplexId")&&e?.Operation&&e.Operation!==this._form.get("operator").value&&this._form.get("operator").setValue(e.Operation),this.flatten(this._form.get("operator").value,e,r,this._form,0)}hasProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)}flatten(e,r,i,l,p){if(this.hasProperty(r,"ComplexId")){const s=r;if(e===r.Operation)this.flatten(r.Operation,s.LeftNode,i,l,p),this.flatten(r.Operation,s.RightNode,i,l,p);else{const u=this.createSection(s.Operation,i,l,p+1);this.flatten(s.Operation,s.LeftNode,u.containerRef,u.parentForm,p+1),this.flatten(s.Operation,s.RightNode,u.containerRef,u.parentForm,p+1)}}else this.hasProperty(r,"ExpressionId")&&this.createItem(r,i,l)}createSection(e,r,i,l){const p=this._resolver.resolveComponentFactory(O),s=r.createComponent(p),u=new d.FormGroup({operator:new d.FormControl(e)});let _=1;Object.keys(i.controls).forEach(v=>{v.includes("section")&&_++});const m=`section${_}`;return i.addControl(m,u),s.instance.form=u,s.instance.depth={current:l,max:this._maxStructureDepth},s.instance.createSection.subscribe(()=>{const v=this.createSection(h.And,s.instance.sectionContainer,u,l+1);this.createItem(null,v.containerRef,v.parentForm)}),s.instance.createItem.subscribe(()=>{this.createItem(null,s.instance.sectionContainer,u)}),s.instance.remove.subscribe(()=>{i.removeControl(m),s.destroy(),this.createOutputQuery(),this._cmpRefMap.has(m)&&this._cmpRefMap.delete(m)}),s.instance.operatorChange.subscribe(()=>{this.createOutputQuery()}),this._cmpRefMap.set(m,s),{containerRef:s.instance.sectionContainer,parentForm:u}}createItem(e,r,i){const l=this._resolver.resolveComponentFactory(j),p=r.createComponent(l);let s=1;Object.keys(i.controls).forEach(m=>{m.includes("item")&&s++});const u=`item${s}`;p.instance.formKey=u,p.instance.fields=this._smartFilterFields,p.instance.variableFields=this._variableFields;const _=this.getSelectedField(e);_&&(p.instance.selected=_,e&&(p.instance.filter=this._queryBuilderService.getFilter(e,_.smart))),p.instance.parentForm=i,p.instance.filterChange.subscribe(()=>{this.createOutputQuery()}),p.instance.remove.subscribe(()=>{i.removeControl(u),p.destroy(),this.createOutputQuery(),this._cmpRefMap.has(u)&&this._cmpRefMap.delete(u)}),this._cmpRefMap.set(u,p)}getSelectedField(e){return e&&this._smartFilterFields.find(i=>i.smart.id===e.ApiName)||(this._smartFilterFields?.length>0?this._smartFilterFields[0]:null)}convertSmartFilterComponentType(e){switch(e){case"int":case"currency":case"real":case"percentage":return"number";case"date-time":return"date";default:return e}}createOutputQuery(){if(this._form.valid){const e=this._outputQueryService.generateQuery(this._form.value);this._outputQuery$.next(e)}}}return n.\u0275fac=function(e){return new(e||n)(t.\u0275\u0275inject(t.ComponentFactoryResolver),t.\u0275\u0275inject(E),t.\u0275\u0275inject(x))},n.\u0275prov=t.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n})(),De=(()=>{class n{constructor(e,r){this._fb=e,this.queryStructureService=r,this._query=null,this.queryChange=new t.EventEmitter,this.formValidationChange=new t.EventEmitter,this._lastFormValidStatus=!0,this.hasFields=!1,this.setupForm(),this.initDepth(),this._formSubscription$=this.queryStructureService.form.valueChanges.subscribe(i=>{this.queryStructureService.form.valid!==this._lastFormValidStatus&&(this._lastFormValidStatus=this.queryStructureService.form.valid,this.formValidationChange.emit(this._lastFormValidStatus))}),this._outputQuerySubscription$=this.queryStructureService.outputQuery$.subscribe(i=>{this.queryChange.emit(i)})}set query(e){this._query=e,this.loadQuery()}set fields(e){this.queryStructureService.fields=e,this.hasFields=this.queryStructureService.hasFields,this.loadQuery()}set variableFields(e){this.queryStructureService.variableFields=e}set maxDepth(e){this.queryStructureService.maxDepth=e}ngOnInit(){}setupForm(){this.queryStructureService.form=this._fb.group({operator:this._fb.control(h.And)})}initDepth(){this.depth={current:0,max:this.queryStructureService.maxDepth}}loadQuery(){this._query&&this.queryStructureService.hasFields&&this.root?.sectionContainer&&this.queryStructureService.buildQueryStructure(this._query,this.root.sectionContainer)}onCreateSection(){const e=this.queryStructureService.createSection(h.And,this.root.sectionContainer,this.queryStructureService.form,1);this.queryStructureService.createItem(null,e.containerRef,e.parentForm)}onCreateItem(){this.queryStructureService.createItem(null,this.root.sectionContainer,this.queryStructureService.form)}onOperatorChange(){this.queryStructureService.createOutputQuery()}ngOnDestroy(){this._formSubscription$&&this._formSubscription$.unsubscribe(),this._outputQuerySubscription$&&this._outputQuerySubscription$.unsubscribe()}}return n.\u0275fac=function(e){return new(e||n)(t.\u0275\u0275directiveInject(d.FormBuilder),t.\u0275\u0275directiveInject(B))},n.\u0275cmp=t.\u0275\u0275defineComponent({type:n,selectors:[["pep-query-builder"]],viewQuery:function(e,r){if(1&e&&t.\u0275\u0275viewQuery(W,7),2&e){let i;t.\u0275\u0275queryRefresh(i=t.\u0275\u0275loadQuery())&&(r.root=i.first)}},inputs:{query:"query",fields:"fields",variableFields:"variableFields",maxDepth:"maxDepth"},outputs:{queryChange:"queryChange",formValidationChange:"formValidationChange"},features:[t.\u0275\u0275ProvidersFeature([B,C,E])],decls:2,vars:3,consts:[[3,"form","depth","hasFields","createSection","createItem","operatorChange"],["rootContainer",""]],template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"pep-query-builder-section",0,1),t.\u0275\u0275listener("createSection",function(){return r.onCreateSection()})("createItem",function(){return r.onCreateItem()})("operatorChange",function(){return r.onOperatorChange()}),t.\u0275\u0275elementEnd()),2&e&&t.\u0275\u0275property("form",r.queryStructureService.form)("depth",r.depth)("hasFields",r.hasFields)},dependencies:[O]}),n})(),Ee=(()=>{class n{constructor(e){this.pepIconRegistry=e,this.pepIconRegistry.registerIcons([F.pepIconSystemBin])}}return n.\u0275fac=function(e){return new(e||n)(t.\u0275\u0275inject(F.PepIconRegistry))},n.\u0275mod=t.\u0275\u0275defineNgModule({type:n}),n.\u0275inj=t.\u0275\u0275defineInjector({providers:[d.FormBuilder],imports:[f.CommonModule,d.ReactiveFormsModule,Q.FlexLayoutModule,T.PepSelectModule,g.PepButtonModule,F.PepIconModule,P.PepGroupButtonsModule,a.PepSmartFiltersModule]}),n})()}}]);