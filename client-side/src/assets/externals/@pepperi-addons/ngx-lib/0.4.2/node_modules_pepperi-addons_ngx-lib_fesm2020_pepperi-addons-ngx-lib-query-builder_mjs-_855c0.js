(self.webpackChunkpage_builder=self.webpackChunkpage_builder||[]).push([["node_modules_pepperi-addons_ngx-lib_fesm2020_pepperi-addons-ngx-lib-query-builder_mjs-_855c0","node_modules_pepperi-addons_ngx-lib_fesm2020_pepperi-addons-ngx-lib-query-builder_mjs-_855c1"],{16130:(xe,C,c)=>{c.r(C),c.d(C,{PepQueryBuilderComponent:()=>Oe,PepQueryBuilderModule:()=>Ie,PepQueryBuilderService:()=>E});var t=c(60562),y=c(62923),d=c(51959),B=c(21756),o=c(13705),S=c(81931),F=c(45757),b=c(32781),Q=c(47593),m=c(85137);const w=["sectionContainer"];function V(n,a){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-button",8),t.\u0275\u0275listener("buttonClick",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(i.onAddRuleSetClicked())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext();t.\u0275\u0275advance(1),t.\u0275\u0275property("disabled",!e.hasFields)("visible",!0)}}function M(n,a){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"pep-button",9),t.\u0275\u0275listener("buttonClick",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(i.onDeleteSectionClicked())}),t.\u0275\u0275elementEnd()}2&n&&t.\u0275\u0275property("disabled",!1)("visible",!0)}function q(n,a){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-text-filter",7),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("variableField",null==e.variableFields?null:e.variableFields.text)("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("renderTitle",!1)}}function L(n,a){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-boolean-filter",8),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("variableField",null==e.variableFields?null:e.variableFields.boolean)("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("options",e.typeConvertorService.booleans)("renderTitle",!1)}}function N(n,a){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-date-filter",9),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("showAdditionalOperators",!0)("variableField",null==e.variableFields?null:e.variableFields.date)("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("renderTitle",!1)}}function A(n,a){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-multi-select-filter",7),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("variableField",null==e.variableFields?null:e.variableFields["multi-select"])("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("renderTitle",!1)}}function k(n,a){if(1&n){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"pep-number-filter",7),t.\u0275\u0275listener("filterChange",function(){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(i.onFilterChanged())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&n){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(1),t.\u0275\u0275property("showActionButtons",!1)("variableField",null==e.variableFields?null:e.variableFields.number)("field",e._selectedField)("filter",e._filter)("parentForm",e.f.smart)("emitOnChange",!0)("inline",!0)("renderTitle",!1)}}function R(n,a){if(1&n&&(t.\u0275\u0275elementContainerStart(0)(1,5),t.\u0275\u0275template(2,q,2,8,"ng-container",6),t.\u0275\u0275template(3,L,2,9,"ng-container",6),t.\u0275\u0275template(4,N,2,9,"ng-container",6),t.\u0275\u0275template(5,A,2,8,"ng-container",6),t.\u0275\u0275template(6,k,2,8,"ng-container",6),t.\u0275\u0275elementContainerEnd()()),2&n){const e=t.\u0275\u0275nextContext();t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitch",e._selectedField.componentType),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","text"),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","boolean"),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","date"),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","multi-select"),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngSwitchCase","number")}}const U=["rootContainer"];let v=(()=>{class n{constructor(){this._operators=[],this._booleans=[],this.initOperators(),this.initBooleans()}get operators(){return this._operators}get booleans(){return this._booleans}initOperators(){this._operators.push({key:"AND",value:"And"}),this._operators.push({key:"OR",value:"Or"})}initBooleans(){this._booleans.push({key:"True",value:"True"}),this._booleans.push({key:"False",value:"False"})}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=t.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n})(),P=(()=>{class n{constructor(e){this._typeConvertorService=e,this.hasFields=!0,this.createSection=new t.EventEmitter,this.createItem=new t.EventEmitter,this.remove=new t.EventEmitter,this.operatorChange=new t.EventEmitter}ngOnInit(){this.initOperators()}get f(){return this.form.controls}initOperators(){this.toggleButtons=this._typeConvertorService.operators.map(e=>({key:e.key,value:e.value,callback:r=>this.onOperatorChanged(r)}))}onOperatorChanged(e){e?.source?.key&&(this.f.operator.setValue(e.source.key),this.operatorChange.emit())}onAddRuleClicked(){this.createItem.emit()}onAddRuleSetClicked(){this.createSection.emit()}onDeleteSectionClicked(){this.remove.emit()}}return n.\u0275fac=function(e){return new(e||n)(t.\u0275\u0275directiveInject(v))},n.\u0275cmp=t.\u0275\u0275defineComponent({type:n,selectors:[["pep-query-builder-section"]],viewQuery:function(e,r){if(1&e&&t.\u0275\u0275viewQuery(w,7,t.ViewContainerRef),2&e){let i;t.\u0275\u0275queryRefresh(i=t.\u0275\u0275loadQuery())&&(r.sectionContainer=i.first)}},inputs:{form:"form",depth:"depth",hasFields:"hasFields"},outputs:{createSection:"createSection",createItem:"createItem",remove:"remove",operatorChange:"operatorChange"},decls:10,vars:8,consts:[["fxLayout","row","fxLayoutGap",".5rem"],["fxLayout","column","fxLayoutGap",".5rem",1,"query-section-container"],["fxLayout","row","fxLayoutAlign","space-between"],["styleType","weak","sizeType","sm",3,"buttons","selectedButtonKey","viewType","buttonsDisabled"],["value","Add Filter","styleType","weak","styleStateType","system","sizeType","sm","classNames","","iconName","number_plus","iconPosition","end",3,"disabled","visible","buttonClick"],[4,"ngIf"],["sectionContainer",""],["styleType","weak","styleStateType","system_bin","sizeType","md","classNames","","iconName","system_bin","iconPosition","end",3,"disabled","visible","buttonClick",4,"ngIf"],["value","Add Filter Group","styleType","weak","styleStateType","system","sizeType","sm","classNames","","iconName","number_plus","iconPosition","end",3,"disabled","visible","buttonClick"],["styleType","weak","styleStateType","system_bin","sizeType","md","classNames","","iconName","system_bin","iconPosition","end",3,"disabled","visible","buttonClick"]],template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"div",0)(1,"div",1)(2,"div",2),t.\u0275\u0275element(3,"pep-group-buttons",3),t.\u0275\u0275elementStart(4,"div",0)(5,"pep-button",4),t.\u0275\u0275listener("buttonClick",function(){return r.onAddRuleClicked()}),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(6,V,2,2,"ng-container",5),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainer(7,null,6),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(9,M,1,2,"pep-button",7),t.\u0275\u0275elementEnd()),2&e&&(t.\u0275\u0275advance(3),t.\u0275\u0275property("buttons",r.toggleButtons)("selectedButtonKey",(null==r.f.operator?null:r.f.operator.value)||"")("viewType","toggle")("buttonsDisabled",!r.hasFields),t.\u0275\u0275advance(2),t.\u0275\u0275property("disabled",!r.hasFields)("visible",!0),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",r.depth.current<r.depth.max-1),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngIf",r.depth.current>0))},dependencies:[y.NgIf,m.DefaultLayoutDirective,m.DefaultLayoutGapDirective,m.DefaultLayoutAlignDirective,F.PepButtonComponent,b.PepGroupButtonsComponent],styles:[".query-section-container[_ngcontent-%COMP%]{border-radius:var(--pep-border-radius-md, .25rem);padding:.5rem;width:100%}",".query-section-container[_ngcontent-%COMP%]{box-shadow:var(--pep-shadow-sm-offset, 0 .25rem .5rem 0) hsla(var(--pep-color-system-primary-h, 0),var(--pep-color-system-primary-s, 0%),var(--pep-color-system-primary-l, 10%),.08);border:1px solid hsla(var(--pep-color-system-primary-h, 0),var(--pep-color-system-primary-s, 0%),var(--pep-color-system-primary-l, 10%),.24)}"]}),n})(),W=(()=>{class n{constructor(e,r){this._fb=e,this.typeConvertorService=r,this._fields=[],this._options=[],this._selectedField=null,this.variableFields={},this.filterChange=new t.EventEmitter,this.remove=new t.EventEmitter,this.setupForm()}set fields(e){e?.length>0&&(this._fields=e,this._options=e.map(r=>({key:r.smart.id,value:r.smart.name})))}set selected(e){e&&(this._selectedField=e.smart,this.queryForm.fieldType.setValue(e.query.fieldType))}set filter(e){e&&(this._filter=e)}set parentForm(e){e&&(this._parentForm=e,this.addToParentForm())}ngOnInit(){}get f(){return this.form.controls}get queryForm(){return this.f.query.controls}setupForm(){this.form=this._fb.group({smart:this._fb.group({fieldId:this._fb.control(null),fieldType:this._fb.control(null),operator:this._fb.control(null),operatorUnit:this._fb.control(null),values:this._fb.group({first:this._fb.control(null),second:this._fb.control(null)})}),query:this._fb.group({fieldType:this._fb.control(null)})})}addToParentForm(){this._parentForm.setControl(this.formKey,this.form)}onFieldChanged(e){const r=this._fields.find(i=>i.smart.id===e);this.setupForm(),this.queryForm.fieldType.setValue(r.query.fieldType),this.addToParentForm(),this._selectedField=null,setTimeout(()=>{this._selectedField=r?r.smart:null},0),this._filter=null}onFilterChanged(){this.form.valid&&this.filterChange.emit()}onDeleteItemClicked(){this.remove.emit()}}return n.\u0275fac=function(e){return new(e||n)(t.\u0275\u0275directiveInject(d.FormBuilder),t.\u0275\u0275directiveInject(v))},n.\u0275cmp=t.\u0275\u0275defineComponent({type:n,selectors:[["pep-query-builder-item"]],inputs:{formKey:"formKey",fields:"fields",selected:"selected",filter:"filter",parentForm:"parentForm",variableFields:"variableFields"},outputs:{filterChange:"filterChange",remove:"remove"},decls:5,vars:6,consts:[["fxLayout","column","fxLayoutGap",".5rem"],["fxLayout","row","fxLayoutGap",".5rem"],["fxFlex","25%","xAlignment","left",3,"value","options","renderTitle","valueChange"],[4,"ngIf"],["styleType","weak","styleStateType","system_bin","sizeType","md","classNames","","iconName","system_bin","iconPosition","end",3,"disabled","visible","buttonClick"],[3,"ngSwitch"],[4,"ngSwitchCase"],["fxFlex","auto",3,"showActionButtons","variableField","field","filter","parentForm","emitOnChange","inline","renderTitle","filterChange"],["fxFlex","auto",3,"showActionButtons","variableField","field","filter","parentForm","emitOnChange","inline","options","renderTitle","filterChange"],["fxFlex","auto",3,"showActionButtons","showAdditionalOperators","variableField","field","filter","parentForm","emitOnChange","inline","renderTitle","filterChange"]],template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"div",0)(1,"div",1)(2,"pep-select",2),t.\u0275\u0275listener("valueChange",function(l){return r.onFieldChanged(l)}),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(3,R,7,6,"ng-container",3),t.\u0275\u0275elementStart(4,"pep-button",4),t.\u0275\u0275listener("buttonClick",function(){return r.onDeleteItemClicked()}),t.\u0275\u0275elementEnd()()()),2&e&&(t.\u0275\u0275advance(2),t.\u0275\u0275property("value",null==r._selectedField?null:r._selectedField.id)("options",r._options)("renderTitle",!1),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",null==r._selectedField?null:r._selectedField.componentType),t.\u0275\u0275advance(1),t.\u0275\u0275property("disabled",!1)("visible",!0))},dependencies:[y.NgIf,y.NgSwitch,y.NgSwitchCase,m.DefaultLayoutDirective,m.DefaultLayoutGapDirective,m.DefaultFlexDirective,S.PepSelectComponent,F.PepButtonComponent,o.PepTextFilterComponent,o.PepBooleanFilterComponent,o.PepDateFilterComponent,o.PepMultiSelectFilterComponent,o.PepNumberFilterComponent],styles:[".pep-field-no-spacing{min-height:0!important;margin-bottom:0!important}"]}),n})();class T{constructor(){this.loadTypes()}loadTypes(){this.map=new Map,this.map.set("Bool","boolean"),this.map.set("JsonBool","boolean"),this.map.set("Integer","int"),this.map.set("Double","real"),this.map.set("String","text"),this.map.set("Guid","text"),this.map.set("Date","date"),this.map.set("DateTime","date-time"),this.map.set("MultipleStringValues","multi-select")}getSmartFilterType(a){return this.map.get(a)||null}}var h=(()=>{return(n=h||(h={})).And="AND",n.Or="OR",h;var n})();const O=[{legacy:"IsEqual",smartFilter:o.PepSmartFilterOperators.Equals,type:["boolean","int","text","real"]},{legacy:"IsEqualVariable",smartFilter:o.PepSmartFilterVariableOperators.EqualsToVariable,type:["boolean","int","text","multi-select"]},{legacy:"IsNotEqual",smartFilter:o.PepSmartFilterOperators.NotEqual,type:null},{legacy:"IsNotEqualVariable",smartFilter:o.PepSmartFilterVariableOperators.NotEqualsToVariable,type:["boolean","multi-select"]},{legacy:"<",smartFilter:o.PepSmartFilterOperators.LessThan,type:null},{legacy:"LessThanVarible",smartFilter:o.PepSmartFilterVariableOperators.LessThanVariable,type:null},{legacy:">",smartFilter:o.PepSmartFilterOperators.GreaterThan,type:null},{legacy:"GreaterThanVarible",smartFilter:o.PepSmartFilterVariableOperators.GreaterThanVariable,type:null},{legacy:"Between",smartFilter:o.PepSmartFilterOperators.NumberRange,type:["int"]},{legacy:"Contains",smartFilter:o.PepSmartFilterOperators.Contains,type:null},{legacy:"BeginsWith",smartFilter:o.PepSmartFilterOperators.BeginsWith,type:null},{legacy:"EndsWith",smartFilter:o.PepSmartFilterOperators.EndsWith,type:null},{legacy:"InTheLast",smartFilter:o.PepSmartFilterOperators.InTheLast,type:null},{legacy:"InTheLastCalendar",smartFilter:o.PepSmartFilterAdditionalOperators.InTheLastCalendar,type:null},{legacy:"NotInTheLast",smartFilter:o.PepSmartFilterOperators.NotInTheLast,type:null},{legacy:"NotInTheLastCalendar",smartFilter:o.PepSmartFilterAdditionalOperators.NotInTheLastCalendar,type:null},{legacy:"Today",smartFilter:o.PepSmartFilterOperators.Today,type:null},{legacy:"ThisWeek",smartFilter:o.PepSmartFilterOperators.ThisWeek,type:null},{legacy:"ThisMonth",smartFilter:o.PepSmartFilterOperators.ThisMonth,type:null},{legacy:"Between",smartFilter:o.PepSmartFilterOperators.DateRange,type:["date-time"]},{legacy:"BetweenVariable",smartFilter:o.PepSmartFilterVariableOperators.DateRangeVariable,type:["date-time"]},{legacy:"DueIn",smartFilter:o.PepSmartFilterOperators.DueIn,type:null},{legacy:"NotDueIn",smartFilter:o.PepSmartFilterOperators.NotDueIn,type:null},{legacy:"On",smartFilter:o.PepSmartFilterOperators.On,type:null},{legacy:"IsEmpty",smartFilter:o.PepSmartFilterOperators.IsEmpty,type:null},{legacy:"IsNotEmpty",smartFilter:o.PepSmartFilterOperators.IsNotEmpty,type:null},{legacy:"IsEqual",smartFilter:o.PepSmartFilterOperators.In,type:["multi-select"]}];function ge(n,a){const e=O.find(r=>r.smartFilter===n&&(null===r.type||r.type.includes(a)));return e?e.legacy:null}const I=[{legacy:"Days",smartFilter:o.PepSmartFilterOperatorUnits.Days},{legacy:"Weeks",smartFilter:o.PepSmartFilterOperatorUnits.Weeks},{legacy:"Months",smartFilter:o.PepSmartFilterOperatorUnits.Months},{legacy:"Years",smartFilter:o.PepSmartFilterOperatorUnits.Years}];let x=(()=>{class n{constructor(){}generateQuery(e){return this.initParams(),this.sectionWalk(e)}initParams(){this._complexIdCounter=1,this._expressionIdCounter=1}sectionWalk(e){let r=null;return Object.keys(e).forEach(i=>{if(i.includes("item"))r=this.addToSection(r,{ExpressionId:(this._expressionIdCounter++).toString(),ApiName:e[i].smart.fieldId,FieldType:e[i].query.fieldType,Operation:ge(e[i].smart.operator,e[i].smart.fieldType),Values:this.getItemValues(e[i].smart)},e.operator);else if(i.includes("section")){const l=this.sectionWalk(e[i]);l&&(r=this.addToSection(r,l,e.operator))}}),r}addToSection(e,r,i){return e?this.createSection(e,r,i):r}createSection(e,r,i){return{ComplexId:(this._complexIdCounter++).toString(),LeftNode:e,RightNode:r,Operation:i}}getItemValues(e){let r=[];return e?.values?.first&&(e.operator===o.PepSmartFilterOperators.In?r=e.values.first:e.operator===o.PepSmartFilterOperators.InTheLast||e.operator===o.PepSmartFilterAdditionalOperators.InTheLastCalendar||e.operator===o.PepSmartFilterOperators.NotInTheLast||e.operator===o.PepSmartFilterAdditionalOperators.NotInTheLastCalendar||e.operator===o.PepSmartFilterOperators.DueIn||e.operator===o.PepSmartFilterOperators.NotDueIn?(r.push(e.values.first),e.operatorUnit&&r.push(function Pe(n){const a=I.find(e=>e.smartFilter===n);return a?a.legacy:null}(e.operatorUnit))):(r.push(e.values.first),e.values.second&&r.push(e.values.second))),r}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=t.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n})(),E=(()=>{class n{constructor(){}getFilter(e,r){const i=function fe(n,a){const e=O.find(r=>r.legacy===n&&(null===r.type||r.type.includes(a)));return e?e.smartFilter:null}(e.Operation,r.type);if(i){const l=this.getFilterValues(e,i,r);return(0,o.createSmartFilter)(e.ApiName,i,l.first,l.second,l.operationUnit)}return null}convertToSmartFilterFields(e){if(e?.length>0){const r=new T;return e.map(i=>({smart:(0,o.createSmartFilterField)({id:i.FieldID,name:i.Title,options:i.OptionalValues?.map(l=>({key:l.Key,value:l.Value}))},r.getSmartFilterType(i.FieldType)),query:{fieldType:i.FieldType}}))}return[]}getFilterValues(e,r,i){const l={first:null,second:null,operationUnit:null};return r===o.PepSmartFilterOperators.In?l.first=e?.Values?.length>0?e.Values.filter(u=>i.options.find(s=>s.key===u)):null:r===o.PepSmartFilterOperators.InTheLast||r===o.PepSmartFilterAdditionalOperators.InTheLastCalendar||r===o.PepSmartFilterOperators.NotInTheLast||r===o.PepSmartFilterAdditionalOperators.NotInTheLastCalendar||r===o.PepSmartFilterOperators.DueIn||r===o.PepSmartFilterOperators.NotDueIn?(l.first=e?.Values?.length>0?e.Values[0]:null,2===e?.Values?.length&&(l.operationUnit=function be(n){const a=I.find(e=>e.legacy===n);return a?a.smartFilter:null}(e.Values[1]))):(l.first=e?.Values?.length>0?e.Values[0]:null,l.second=2===e?.Values?.length?e.Values[1]:null),l}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=t.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac,providedIn:"root"}),n})(),D=(()=>{class n{constructor(e,r,i){this._resolver=e,this._outputQueryService=r,this._queryBuilderService=i,this._outputQuery$=new Q.BehaviorSubject(null),this._variableFields={},this._maxStructureDepth=3,this.outputQuery$=this._outputQuery$.asObservable()}set maxDepth(e){this._maxStructureDepth=e}get maxDepth(){return this._maxStructureDepth}set fields(e){this._smartFilterFields=this._queryBuilderService.convertToSmartFilterFields(e)}get hasFields(){return this._smartFilterFields?.length>0}set variableFields(e){if(e?.length){const r=new T;e.forEach(i=>{const l=this.convertSmartFilterComponentType(r.getSmartFilterType(i.FieldType));this.hasProperty(this._variableFields,l)?this._variableFields[l].push(i.FieldID):this._variableFields[l]=[i.FieldID]})}}set form(e){this._form=e}get form(){return this._form}buildQueryStructure(e,r){this.hasProperty(e,"ComplexId")&&e?.Operation&&e.Operation!==this._form.get("operator").value&&this._form.get("operator").setValue(e.Operation),this.flatten(this._form.get("operator").value,e,r,this._form,0)}hasProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)}flatten(e,r,i,l,u){if(this.hasProperty(r,"ComplexId")){const s=r;if(e===r.Operation)this.flatten(r.Operation,s.LeftNode,i,l,u),this.flatten(r.Operation,s.RightNode,i,l,u);else{const p=this.createSection(s.Operation,i,l,u+1);this.flatten(s.Operation,s.LeftNode,p.containerRef,p.parentForm,u+1),this.flatten(s.Operation,s.RightNode,p.containerRef,p.parentForm,u+1)}}else this.hasProperty(r,"ExpressionId")&&this.createItem(r,i,l)}createSection(e,r,i,l){const u=this._resolver.resolveComponentFactory(P),s=r.createComponent(u),p=new d.FormGroup({operator:new d.FormControl(e)});let _=1;Object.keys(i.controls).forEach(g=>{g.includes("section")&&_++});const f=`section${_}`;return i.addControl(f,p),s.instance.form=p,s.instance.depth={current:l,max:this._maxStructureDepth},s.instance.createSection.subscribe(()=>{const g=this.createSection(h.And,s.instance.sectionContainer,p,l+1);this.createItem(null,g.containerRef,g.parentForm)}),s.instance.createItem.subscribe(()=>{this.createItem(null,s.instance.sectionContainer,p)}),s.instance.remove.subscribe(()=>{i.removeControl(f),s.destroy(),this.createOutputQuery()}),s.instance.operatorChange.subscribe(()=>{this.createOutputQuery()}),{containerRef:s.instance.sectionContainer,parentForm:p}}createItem(e,r,i){const l=this._resolver.resolveComponentFactory(W),u=r.createComponent(l);let s=1;Object.keys(i.controls).forEach(f=>{f.includes("item")&&s++});const p=`item${s}`;u.instance.formKey=p,u.instance.fields=this._smartFilterFields,u.instance.variableFields=this._variableFields;const _=this.getSelectedField(e);_&&(u.instance.selected=_,e&&(u.instance.filter=this._queryBuilderService.getFilter(e,_.smart))),u.instance.parentForm=i,u.instance.filterChange.subscribe(()=>{this.createOutputQuery()}),u.instance.remove.subscribe(()=>{i.removeControl(p),u.destroy(),this.createOutputQuery()})}getSelectedField(e){return e&&this._smartFilterFields.find(i=>i.smart.id===e.ApiName)||(this._smartFilterFields?.length>0?this._smartFilterFields[0]:null)}convertSmartFilterComponentType(e){switch(e){case"int":case"currency":case"real":case"percentage":return"number";case"date-time":return"date";default:return e}}createOutputQuery(){if(this._form.valid){const e=this._outputQueryService.generateQuery(this._form.value);this._outputQuery$.next(e)}}}return n.\u0275fac=function(e){return new(e||n)(t.\u0275\u0275inject(t.ComponentFactoryResolver),t.\u0275\u0275inject(x),t.\u0275\u0275inject(E))},n.\u0275prov=t.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac}),n})(),Oe=(()=>{class n{constructor(e,r){this._fb=e,this.queryStructureService=r,this._query=null,this.queryChange=new t.EventEmitter,this.formValidationChange=new t.EventEmitter,this._lastFormValidStatus=!0,this.hasFields=!1,this.setupForm(),this.initDepth(),this._formSubscription$=this.queryStructureService.form.valueChanges.subscribe(i=>{this.queryStructureService.form.valid!==this._lastFormValidStatus&&(this._lastFormValidStatus=this.queryStructureService.form.valid,this.formValidationChange.emit(this._lastFormValidStatus))}),this._outputQuerySubscription$=this.queryStructureService.outputQuery$.subscribe(i=>{this.queryChange.emit(i)})}set query(e){this._query=e,this.loadQuery()}set fields(e){this.queryStructureService.fields=e,this.hasFields=this.queryStructureService.hasFields,this.loadQuery()}set variableFields(e){this.queryStructureService.variableFields=e}set maxDepth(e){this.queryStructureService.maxDepth=e}ngOnInit(){}setupForm(){this.queryStructureService.form=this._fb.group({operator:this._fb.control(h.And)})}initDepth(){this.depth={current:0,max:this.queryStructureService.maxDepth}}loadQuery(){this._query&&this.queryStructureService.hasFields&&this.root?.sectionContainer&&this.queryStructureService.buildQueryStructure(this._query,this.root.sectionContainer)}onCreateSection(){const e=this.queryStructureService.createSection(h.And,this.root.sectionContainer,this.queryStructureService.form,1);this.queryStructureService.createItem(null,e.containerRef,e.parentForm)}onCreateItem(){this.queryStructureService.createItem(null,this.root.sectionContainer,this.queryStructureService.form)}onOperatorChange(){this.queryStructureService.createOutputQuery()}ngOnDestroy(){this._formSubscription$&&this._formSubscription$.unsubscribe(),this._outputQuerySubscription$&&this._outputQuerySubscription$.unsubscribe()}}return n.\u0275fac=function(e){return new(e||n)(t.\u0275\u0275directiveInject(d.FormBuilder),t.\u0275\u0275directiveInject(D))},n.\u0275cmp=t.\u0275\u0275defineComponent({type:n,selectors:[["pep-query-builder"]],viewQuery:function(e,r){if(1&e&&t.\u0275\u0275viewQuery(U,7),2&e){let i;t.\u0275\u0275queryRefresh(i=t.\u0275\u0275loadQuery())&&(r.root=i.first)}},inputs:{query:"query",fields:"fields",variableFields:"variableFields",maxDepth:"maxDepth"},outputs:{queryChange:"queryChange",formValidationChange:"formValidationChange"},features:[t.\u0275\u0275ProvidersFeature([D,v,x])],decls:2,vars:3,consts:[[3,"form","depth","hasFields","createSection","createItem","operatorChange"],["rootContainer",""]],template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"pep-query-builder-section",0,1),t.\u0275\u0275listener("createSection",function(){return r.onCreateSection()})("createItem",function(){return r.onCreateItem()})("operatorChange",function(){return r.onOperatorChange()}),t.\u0275\u0275elementEnd()),2&e&&t.\u0275\u0275property("form",r.queryStructureService.form)("depth",r.depth)("hasFields",r.hasFields)},dependencies:[P]}),n})(),Ie=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.\u0275\u0275defineNgModule({type:n}),n.\u0275inj=t.\u0275\u0275defineInjector({providers:[d.FormBuilder],imports:[y.CommonModule,d.ReactiveFormsModule,B.FlexLayoutModule,S.PepSelectModule,F.PepButtonModule,b.PepGroupButtonsModule,o.PepSmartFiltersModule]}),n})()}}]);